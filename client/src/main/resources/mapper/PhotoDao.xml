<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boss.client.dao.PhotoDao">


    <select id="photoCount" resultType="java.lang.Integer">
        SELECT
            count(*)
        FROM
            tb_photo as s
        <if test="condition.tag_ids != null">
            left join tb_productorimg_tag as t on t.itemOrImg_id = s.id
        </if>
        <where>
            <if test="condition.sku_id != null">
                s.name = #{condition.sku_id}
            </if>
            <if test="condition.start_time != null">
                and s.create_time >= #{condition.start_time}
            </if>
            <if test="condition.end_time != null">
                and s.create_time &lt;= #{condition.end_time}
            </if>
            <if test="condition.tag_ids != null">
                and t.tag_id IN
                <foreach item="id" index="tagId" collection="tag_ids" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
            </if>
            <if test="condition.rule_grade != null">
                and id IN
                <foreach item="id" index="index" collection="ids" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
        </where>
    </select>


    <select id="photoList" resultType="com.boss.client.vo.PhotoVO">
        SELECT
            s.id,
            s.photo_name,
            s.photo_src,
            s.create_time,
            t.id as skuId,
            t.name as skuName,
            IFNULL(p.count, 0) as salesVolume
        FROM
            tb_photo as s, tb_sku as t
            left join tb_order_item as p on p.sku_name = t.name
        <if test="condition.tag_ids != null">
            left join tb_productorimg_tag as tag on tag.itemOrImg_id = s.id
        </if>
        <where>
            s.sku_id = t.id
            <if test="condition.sku_id != null">
                s.name = #{condition.sku_id}
            </if>
            <if test="condition.start_time != null">
                and s.create_time >= #{condition.start_time}
            </if>
            <if test="condition.end_time != null">
                and s.create_time &lt;= #{condition.end_time}
            </if>
            <if test="condition.tag_ids != null">
                and tag.tag_id IN
                <foreach item="id" index="tagId" collection="tag_ids" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
            </if>
            <if test="condition.rule_grade != null">
                and id IN
                <foreach item="id" index="index" collection="ids" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
        </where>
        <if test="condition.orderBy_name != null and condition.orderBy_name.contains('grade')">
            ORDER BY FIELD(id,
            <foreach item="id" index="index" collection="itemIds" separator=",">
                #{id}
            </foreach>)
        </if>
        <if test="condition.orderBy_name != null and !condition.orderBy_name.contains('grade')">
            order by ${condition.orderBy_name}
        </if>
        LIMIT #{current},#{size}
    </select>


    <resultMap id="photoResultMap" type="com.boss.client.vo.PhotoInfoVO">
        <id column="id" property="id"/>
        <result column="photo_name" property="photoName"/>
        <result column="photo_src" property="photoSrc"/>
        <result column="create_time" property="createTime"/>
        <result column="sku_id" property="skuId"/>
        <result column="sku_name" property="skuName"/>
        <result column="salesVolume" property="salesVolume"/>
        <collection property="tagVOList" ofType="com.boss.client.vo.TagVO">
            <id column="tag_id" property="id"/>
            <result column="tag_name" property="tagName"/>
            <result column="tag_type" property="tagType"/>
        </collection>
    </resultMap>

    <select id="getPhotoInfoById" resultMap="photoResultMap">
        SELECT
            s.id,
            s.photo_name,
            s.photo_src,
            s.sku_id,
            p.name as sku_name,
            DATE_FORMAT(s.create_time, '%Y-%m-%d %H:%i:%s') as create_time,
            t.id AS tag_id,
            t.tag_name,
            t.tag_type,
            IFNULL(ocount, 0) as salesVolume
        FROM
            tb_photo as s
        left join tb_sku as p ON s.sku_id = p.id
        left JOIN tb_productorimg_tag as d ON s.id = d.itemOrImg_id  and d.tag_type = "PHOTO"
        left JOIN tb_tag as t ON t.id = d.tag_id
        left join tb_order_item as o on o.sku_name = p.name
        WHERE
            s.id = #{photoId}
    </select>

</mapper>
