<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boss.client.dao.PhotoDao">


    <select id="photoCount" resultType="java.lang.Integer">
        select count(*) from (
        SELECT
        count(*)
        FROM
        tb_photo as s
        left join tb_sku as t on s.sku_id = t.id
        left join tb_order_item as p on p.sku_name = t.name
        <where>
            <if test="condition.photo_name != null">
                s.photo_name = #{condition.photo_name}
            </if>
            <if test="condition.sku_id != null">
                t.id = #{condition.sku_id}
            </if>
            <if test="condition.start_time != null">
                and s.create_time >= #{condition.start_time}
            </if>
            <if test="condition.end_time != null">
                and s.create_time &lt;= #{condition.end_time}
            </if>
            <if test="condition.grade != null">
                t.grade = #{condition.grade}
            </if>
            <if test="condition.max_value != 0">
                and IFNULL(sum(p.count), 0) &lt;= #{condition.max_value}
            </if>
            <if test="condition.min_value != 0">
                and IFNULL(sum(p.count), 0) >= #{condition.min_value}
            </if>
        </where>
        group by s.id
        ) as a
    </select>


    <select id="photoList" resultType="com.boss.client.vo.PhotoVO">
        SELECT
            s.id,
            s.photo_name,
            s.photo_src,
            s.create_time,
            t.id as skuId,
            t.name as skuName,
            t.grade,
            IFNULL(sum(p.count), 0) as salesVolume
        FROM
            tb_photo as s
            left join tb_sku as t on s.sku_id = t.id
            left join tb_order_item as p on p.sku_name = t.name
        <where>
            <if test="condition.photo_name != null">
                s.photo_name = #{condition.photo_name}
            </if>
            <if test="condition.sku_id != null">
                t.id = #{condition.sku_id}
            </if>
            <if test="condition.start_time != null">
                and s.create_time >= #{condition.start_time}
            </if>
            <if test="condition.end_time != null">
                and s.create_time &lt;= #{condition.end_time}
            </if>
            <if test="condition.grade != null">
                and s.grade = #{condition.grade}
            </if>
            <if test="condition.max_value != 0">
                and IFNULL(sum(p.count), 0) &lt;= #{condition.max_value}
            </if>
            <if test="condition.min_value != 0">
                and IFNULL(sum(p.count), 0) >= #{condition.min_value}
            </if>
        </where>
        group by s.id
        <if test="condition.orderBy_name != null">
            order by ${condition.orderBy_name}
        </if>
        LIMIT #{current},#{size}
    </select>


<!--    <resultMap id="photoResultMap" type="com.boss.client.vo.PhotoInfoVO">-->
<!--        <id column="id" property="id"/>-->
<!--        <result column="photo_name" property="photoName"/>-->
<!--        <result column="photo_src" property="photoSrc"/>-->
<!--        <result column="create_time" property="createTime"/>-->
<!--        <result column="sku_id" property="skuId"/>-->
<!--        <result column="sku_name" property="skuName"/>-->
<!--        <result column="salesVolume" property="salesVolume"/>-->
<!--    </resultMap>-->

    <select id="getPhotoInfoById" resultType="com.boss.client.vo.PhotoInfoVO">
        SELECT
            s.id,
            s.photo_name,
            s.photo_src,
            s.sku_id,
            p.name as sku_name,
            p.grade,
            DATE_FORMAT(s.create_time, '%Y-%m-%d %H:%i:%s') as create_time,
            IFNULL(o.count, 0) as salesVolume
        FROM
            tb_photo as s
        left join tb_sku as p ON s.sku_id = p.id
        left join tb_order_item as o on o.sku_name = p.name
        WHERE
            s.id = #{photoId}
        group by s.id
    </select>

</mapper>
