<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boss.client.dao.ProductDao">


    <select id="productCount" resultType="java.lang.Integer">
        SELECT
            count(*)
        FROM
            tb_product s
        <if test="condition.tag_id != null">
            left join tb_productorimg_tag as t on t.itemOrImg_id = s.id
        </if>
        <where>
            s.id is not null
            <if test="condition.item_id != null">
                and s.item_id = #{condition.item_id}
            </if>
            <if test="condition.item_sku != null">
                and s.item_sku = #{condition.item_sku}
            </if>
            <if test="condition.item_status != null">
                and s.status = #{condition.item_status}
            </if>
            <if test="condition.category_id != null">
                and s.category_id = #{condition.category_id}
            </if>
            <if test="condition.shop_id != null">
                and s.shop_id = #{condition.shop_id}
            </if>
            <if test="condition.start_time != null">
                and s.create_time >= UNIX_TIMESTAMP(STR_TO_DATE(#{condition.start_time}, '%Y-%m-%d %H:%i:%s'))
            </if>
            <if test="condition.end_time != null">
                and s.create_time &lt;= UNIX_TIMESTAMP(STR_TO_DATE(#{condition.end_time}, '%Y-%m-%d %H:%i:%s'))
            </if>
            <if test="condition.grade != null">
                and s.grade = #{condition.grade}
            </if>
            <if test="condition.tag_id != null">
                and t.tag_id  = #{condition.tag_id}
            </if>
        </where>
    </select>


    <select id="productList" resultType="com.boss.client.vo.ProductVO">
        SELECT
            s.id,
            s.item_id,
            s.category_id,
            c.name as category_name,
            s.item_name,
            s.item_sku,
            s.mainImg_url,
            s.grade,
            t.name as shop_name,
            s.status, FROM_UNIXTIME(s.create_time, '%Y-%m-%d %H:%i:%s') as create_time,
            IFNULL(d.sale, 0) as salesVolume
        FROM
            tb_product s
        left join tb_product_extra_info d
            on s.item_id = d.item_id
        left join tb_shop as t
            on s.shop_id = t.shop_id
        <if test="condition.tag_id != null">
            left join tb_productorimg_tag as tag
                on tag.itemOrImg_id = s.id
        </if>
        left join tb_category as c
            on s.category_id = c.id
        <where>
            s.id is not null
            <if test="condition.item_id != null">
                and s.item_id = #{condition.item_id}
            </if>
            <if test="condition.item_sku != null">
                and s.item_sku = #{condition.item_sku}
            </if>
            <if test="condition.item_status != null">
                and s.status = #{condition.item_status}
            </if>
            <if test="condition.category_id != null">
                and s.category_id = #{condition.category_id}
            </if>
            <if test="condition.shop_id != null">
                and s.shop_id = #{condition.shop_id}
            </if>
            <if test="condition.start_time != null">
                and s.create_time >= UNIX_TIMESTAMP(STR_TO_DATE(#{condition.start_time}, '%Y-%m-%d %H:%i:%s'))
            </if>
            <if test="condition.end_time != null">
                and s.create_time &lt;= UNIX_TIMESTAMP(STR_TO_DATE(#{condition.end_time}, '%Y-%m-%d %H:%i:%s'))
            </if>
            <if test="condition.grade != null">
                and s.grade = #{condition.grade}
            </if>
            <if test="condition.tag_id != null">
                and tag.tag_id  = #{condition.tag_id}
            </if>
        </where>
        <if test="condition.orderBy_name != null">
            order by ${condition.orderBy_name}
        </if>
        LIMIT #{current},#{size}
    </select>

<!--    <resultMap id="productResultMap" type="com.boss.client.vo.ProductInfoVO">-->
<!--        <id column="id" property="id"/>-->
<!--        <result column="item_id" property="itemId"/>-->
<!--        <result column="create_time" property="createTime"/>-->
<!--        <result column="update_time" property="updateTime"/>-->
<!--        <result column="category_id" property="categoryId"/>-->
<!--        <result column="category_name" property="categoryName"/>-->
<!--        <result column="item_name" property="itemName"/>-->
<!--        <result column="item_sku" property="itemSku"/>-->
<!--        <result column="status" property="status"/>-->
<!--        <result column="shop_id" property="shopId"/>-->
<!--        <result column="shop_name" property="shopName"/>-->
<!--        <collection property="tagVOList" ofType="com.boss.client.vo.TagVO">-->
<!--            <id column="tag_id" property="id"/>-->
<!--            <result column="tag_name" property="tagName"/>-->
<!--            <result column="tag_type" property="tagType"/>-->
<!--        </collection>-->
<!--    </resultMap>-->

    <select id="getProductInfo" resultType="com.boss.client.vo.ProductInfoVO">
        select
            s.id,
            s.item_id,
            FROM_UNIXTIME(s.create_time, '%Y-%m-%d %H:%i:%s') as create_time,
            FROM_UNIXTIME(s.update_time, '%Y-%m-%d %H:%i:%s') as update_time,
            s.category_id,
            c.name as category_name,
            s.item_name,
            s.item_sku,
            s.status,
            s.shop_id,
            s.grade,
            t.name as shop_name
        from
            tb_product as s
        left JOIN tb_shop as t
            on s.shop_id = t.shop_id
        left join tb_category as c
            on s.category_id = c.id
        where s.id = #{item_id}
    </select>

    <select id="productGrade" resultType="com.boss.client.vo.ProductVO">
        select
            s.id,
            s.item_id,
            s.create_time
            s.update_time
            s.category_id,
            s.item_sku,
            s.status
        from
            tb_product as s
                left JOIN tb_product_extra_info as d on s.id = d.id

    </select>

    <select id="getNewerSaleProductNames" resultType="java.lang.String">
        SELECT
            s.item_name
        FROM
            tb_product AS s, tb_product_extra_info As p
        where
            s.id = p.id
          and s.create_time >= UNIX_TIMESTAMP(NOW()) - 2592000
          and p.sale > 0
    </select>
</mapper>
